function doGet(e) {
  var userName = e.parameter.userName;
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(userName);
  
  if (!sheet) return ContentService.createTextOutput("[]").setMimeType(ContentService.MimeType.JSON);
  
  var data = sheet.getDataRange().getValues();
  var result = [];
  for (var i = 1; i < data.length; i++) {
    result.push({
      date: data[i][0],
      sys: data[i][1],
      dia: data[i][2],
      pulse: data[i][3]
    });
  }
  return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  var postData = JSON.parse(e.postData.contents);
  var userName = postData.userName;
  var healthData = postData.data;
  
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(userName) || ss.insertSheet(userName);
  
  sheet.clear();
  sheet.appendRow(["Date", "Systolic", "Diastolic", "Pulse"]);
  
  healthData.forEach(function(row) {
    sheet.appendRow([row.date, row.sys, row.dia, row.pulse]);
  });
  
  return ContentService.createTextOutput("Success");
}

